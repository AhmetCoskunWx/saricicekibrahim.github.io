var app=angular.module("droneApp",[]).controller("droneCtrl",["$scope","$http",function(e,t){function o(e){return Math.pow(2,-10*e)*Math.sin((e-.075)*(2*Math.PI)/.3)+1}var a=document.getElementById("popup"),r=document.getElementById("popup-content"),n=document.getElementById("popup-closer");e.videoFilter={search:""};var u=new ol.Overlay({element:a,autoPan:!0,autoPanAnimation:{duration:250}});e.filteredMapData,e.filterMap=function(){setTimeout(function(){e.features=[],angular.forEach(e.filteredMapData,function(t,o){e.features.push(new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(e.getLatLonAsArray(t[0]),"EPSG:4326","EPSG:3857")),youtube_id:t[1],descr:t[2]}))}),e.videoMapSource.clear(),e.videoMapSource.addFeatures(e.features)},2e3)},n.onclick=function(){e.closePopup()},e.closePopup=function(){return r.innerHTML=null,u.setPosition(void 0),n.blur(),!1},e.getIframeSrc=function(e){return"https://www.youtube.com/watch?v="+e},e.view=new ol.View({center:ol.proj.transform([32.9,39.9],"EPSG:4326","EPSG:3857"),zoom:10}),e.map=new ol.Map({interactions:ol.interaction.defaults().extend([new ol.interaction.DragRotateAndZoom]),target:"map",layers:[new ol.layer.Tile({source:new ol.source.Stamen({layer:"terrain"})})],view:e.view,overlays:[u]}),e.screenBigEnough=function(){return $(window).width()>750},e.videoLayer=null,e.videoMapSource=null,e.features=[],e.mapData=[],new ol.source.Vector({features:null});var i=[];t.get("https://sheets.googleapis.com/v4/spreadsheets/1_2J3C_78i9GGbZNznGZD3OIzBaFGZFv1OBiGcCG5s1U/values/A1:D250?key=AIzaSyBalaFs-lUjr0cck_aGIqI4WQHcCYRZ2FE").then(function(t){e.mapData=t.data.values,i=t.data.values,angular.forEach(e.mapData,function(t,o){e.features.push(new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(e.getLatLonAsArray(t[0]),"EPSG:4326","EPSG:3857")),youtube_id:t[1],descr:t[2]}))}),e.videoMapSource=new ol.source.Vector({features:e.features}),e.videoLayer=new ol.layer.Vector({source:e.videoMapSource,style:new ol.style.Style({image:new ol.style.Icon({src:"img/videoIcon.png"})})}),e.map.addLayer(e.videoLayer),e.map.getView().fit(e.videoLayer.getSource().getExtent(),e.map.getSize())}),e.zoomToVideo=function(t){e.view.animate({center:ol.proj.fromLonLat(e.getLatLonAsArray(t)),duration:2e3,easing:o})},e.getPopupContent=function(t){return e.screenBigEnough()?t.get("descr")+"<iframe width='350' height='250' src='https://www.youtube.com/embed/"+t.get("youtube_id")+"' frameborder='0' allowfullscreen></iframe>":t.get("descr")+"<br><a href='https://www.youtube.com/watch?v="+t.get("youtube_id")+"' target='_blank'>Click for Video</a>"},e.getLatLonAsArray=function(e){var t=e.split(",");return[parseFloat(t[1]),parseFloat(t[0])]},e.map.on("click",function(t){var o=e.map.forEachFeatureAtPixel(t.pixel,function(e){return e});o?(r.innerHTML=e.getPopupContent(o),u.setPosition(t.coordinate)):e.closePopup()}),e.map.on("moveend",function(t){var o=t.map,a=o.getView().calculateExtent(o.getSize()),r=ol.proj.transform(ol.extent.getBottomLeft(a),"EPSG:3857","EPSG:4326"),n=ol.proj.transform(ol.extent.getTopRight(a),"EPSG:3857","EPSG:4326");e.mapData=[],angular.forEach(i,function(t,o){var a=e.getLatLonAsArray(t[0]);a[0]>r[0]&&a[0]<n[0]&&a[1]>r[1]&&a[1]<n[1]&&e.mapData.push(t)}),e.$apply()})}]);